

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(tidyverse)
library(readxl)
library(janitor)
library(xml2)
library(rvest)

```


```{r codes}

# This is a list of codes that are assigned to each country. I plan to join
# this dataset with my military base dataset so I can then easily join the 
# joined dataset with my other ones.

codes <- read_csv("raw-data/COW.csv") %>% 
  clean_names() %>% 
  select(c_code, state_nme)

```


```{r coups}

coups <- read_excel("raw-data/Coupdata.xls") %>% 
  clean_names()

coups_clean <- coups %>% 
  select(cow_code, country_where_action_occurred, year_of_event, month_of_event, day_of_event, type_of_coup, realized_coup, unrealized, military_coup, rebel_coup, palace_coup)

coups <- coups_clean %>% 
  filter(year_of_event == 1991) %>% 
  select(cow_code, country_where_action_occurred, realized_coup)

coups_regime <- coups_clean %>% 
  select(cow_code, country_where_action_occurred, year_of_event, realized_coup)

```


```{r polity}

polity_raw <- read_excel("raw-data/polity_iv.xls") %>% 
  clean_names() 

polity <- polity_raw %>% 
  filter(year == 1991) %>% 
  select(ccode, country, polity)

polity_regime <- polity_raw %>% 
  select(ccode, country, year, polity)

```

```{r bases}

bases <- read_excel("raw-data/basesabroad.xlsx", sheet = "1989", skip = 13) %>% 
  clean_names() %>% 
  rename("base_name" = x2) 

bases$country_name <- tolower(bases$country_name)

yes_bases <- bases %>% 
  select(country_name, base_name) %>% 
  filter(!is.na(base_name)) %>% 
  group_by(country_name) %>% 
  count()

# I previously saved the yes_bases dataframe as a .csv file. Then, I manually
# cleaned the data in the "Numbers" Mac application, as the dataframe contained
# many territories that were not countries and formatted the country names 
# oddly. I reformatted the country names so I could eventually join this dataset
# with my other ones. The dataset that I cleaned manually is called 
# "clean_bases.csv". Here I am reading in that dataset and cleaning the names
# again, and only selecting the relevant columns.

bases_clean <- read_csv("raw-data/clean_bases.csv") %>% 
  clean_names() %>% 
  select(country_name, n)


```

```{r infant}

infant <- read_excel("raw-data/infant_mort.xls", 
                       skip = 2) %>% 
  clean_names() %>% 
  select(-indicator_name, -indicator_code)

infant <- infant %>% 
  pivot_longer(
    cols = starts_with("x"),
    names_to = "year",
    values_to = "infant_mortality_rate",
    names_prefix = "x")

infant_clean <- infant %>% 
  filter(year == 1991)

infant_clean <- infant_clean %>% 
  mutate(mort_rate = infant_mortality_rate/1000 * 100) %>% 
  filter(!is.na(mort_rate)) %>% 
  select(country_code, country_name, mort_rate)



```


```{r births}

births <- read_excel("raw-data/births.xls", 
                     skip = 2) %>% 
  clean_names() %>% 
  select(-indicator_name, -indicator_code)

births <- births %>% 
  pivot_longer(
    cols = starts_with("x"),
    names_to = "year",
    values_to = "birth_rate",
    names_prefix = "x")

clean_births <- births %>% 
  filter(year == 1991) %>% 
  filter(!is.na(birth_rate)) %>% 
  select(country_code, country_name, birth_rate)

```


```{r deaths}


deaths <- read_excel("raw-data/deaths.xls",
                     skip = 2) %>% 
  clean_names() %>% 
  select(-indicator_name, -indicator_code)

deaths <- deaths %>% 
  pivot_longer(
   cols =  starts_with("x"),
    names_to = "year",
   values_to = "death_rate",
   names_prefix = "x")

clean_deaths <- deaths %>% 
  filter(year == 1991) %>% 
  filter(!is.na(death_rate)) %>% 
  select(country_code, country_name, death_rate)

```


```{r join}

join1 <- full_join(infant_clean, clean_births, by = c("country_name" = "country_name",
                                                      "country_code" = "country_code"))

dev_indc <- full_join(join1, clean_deaths, by = c("country_name" = "country_name",
                                                  "country_code" = "country_code"))

bases_dev <- full_join(dev_indc, bases_clean, by = c("country_name" = "country_name"))

bases_dev$n[is.na(bases_dev$n)] <- 0

full_clean <- bases_dev %>% 
  mutate(level_infl = case_when(n %in% 1:10 ~ '3',
                                n %in% 10:50 ~ '2',
                                n > 50 ~ '1',
                                TRUE ~ '4')) %>% 
  filter(!is.na(mort_rate))


```


```{r gov_type}

url <- "https://www.cia.gov/library/publications/the-world-factbook/fields/299.html"

countries <- url %>% 
  read_html() %>% 
  html_nodes(xpath = '//*[@id="fieldListing"]') %>% 
  html_table()

countries <- data.frame(countries)

countries <- countries %>% 
  clean_names()

clean_countries <- countries %>% 
  mutate(control = case_when(
    str_detect(government_type, "absolute monarchy") ~ '1',
    str_detect(government_type, "communist") ~ '1',
    str_detect(government_type, "semi-presidential") ~ '2',
    str_detect(government_type, "federal parliamentary") ~ '3',
    str_detect(government_type, "federal republic") ~ '3',
    str_detect(government_type, "federation") ~ '3',
    str_detect(government_type, "presidential") ~ '3',
    str_detect(government_type, "parliamentary republic") ~ '2',
    str_detect(government_type, "constitutional monarchy") ~ '2',
    str_detect(government_type, "parliamentary democracy") ~ '2',
    str_detect(government_type, "theocratic republic") ~ '2')) %>% 
  filter(!is.na(control))


```


```{r final_join}

coups_dev <- full_join(full_clean, coups, by = c("country_name" = "country_where_action_occurred")) %>% 
  select(country_name, mort_rate, birth_rate, death_rate, level_infl, realized_coup)

coups_dev$realized_coup[is.na(coups_dev$realized_coup)] <- 0

```

```{r}

# I realized that the above dataset was not completely clean. Some rows didn't
# contain observations for individual countries, but whole regions or income
# groups. I decided to write the data to a csv file to clean it manually. Here
# I am reading in that csv file.

clean_coups_dev <- read_csv("raw-data/clean2.csv") %>% 
  select(-X1)

coup_country <- full_join(clean_coups_dev, clean_countries, 
                  by = c("country_name" = "country")) %>% 
  select(-government_type) %>% 
  filter(!is.na(mort_rate)) %>% 
  filter(!is.na(birth_rate)) %>% 
  filter(!is.na(death_rate)) %>% 
  filter(!is.na(level_infl)) %>% 
  filter(!is.na(realized_coup)) %>% 
  filter(!is.na(control))

save(coup_country, file = "data/coup_data.rds")

```

```{r}

regime_full <- full_join(coups_regime, polity_regime, 
                         by = c("cow_code" = "ccode",
                                "country_where_action_occurred" = "country",
                                "year_of_event" = "year"))
regime_full <- regime_full %>% 
  filter(polity != -88) %>% 
  filter(polity != -77) %>% 
  filter(polity != -66)

save(regime_full, file = "data/regime_coup.rds")

```

